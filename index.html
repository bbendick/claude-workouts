<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://api.github.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Gym Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #4CAF50;
            margin-bottom: 10px;
            position: relative;
        }
        
        .settings-btn {
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px;
            border-radius: 3px;
            transition: color 0.2s, background-color 0.2s;
        }
        
        .settings-btn:hover {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .setup-screen, .workout-selection, .exercise-selection, .workout-screen {
            display: none;
        }
        
        .setup-screen.active, .workout-selection.active, .exercise-selection.active, .workout-screen.active {
            display: block;
        }
        
        .setup-form {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 16px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .last-workout {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .workout-option {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }
        
        .workout-option:hover {
            border-color: #4CAF50;
        }
        
        .workout-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .exercise-count {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .exercise-option {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .exercise-option:hover {
            border-color: #4CAF50;
        }
        
        .exercise-left {
            flex: 1;
        }
        
        .exercise-right {
            flex: 0 0 auto;
            text-align: right;
            margin-left: 20px;
        }
        
        .exercise-name-option {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .exercise-details {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .exercise-weight-display {
            color: #ff9800;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .exercise-option.completed {
            border: 2px solid #4CAF50;
            background: #1a3d1a;
        }
        
        .exercise-option.completed::after {
            content: "‚úì";
            position: absolute;
            top: 10px;
            right: 15px;
            color: #4CAF50;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .exercise-option {
            position: relative;
        }
        
        .current-exercise {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-exercise-left {
            flex: 1;
        }
        
        .current-exercise-right {
            flex: 0 0 auto;
            text-align: right;
            margin-left: 20px;
        }
        
        .exercise-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #4CAF50;
        }
        
        .exercise-weight {
            font-size: 2rem;
            font-weight: bold;
            color: #ff9800;
        }
        
        .exercise-info {
            margin-bottom: 15px;
            color: #ccc;
        }
        
        .sets-progress {
            margin-bottom: 20px;
        }
        
        .set-info {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .rep-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .rep-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rep-button:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .rep-button:disabled {
            background: #666;
            transform: none;
        }
        
        .rep-count {
            font-size: 2rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        .timer {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .timer-label {
            color: #ccc;
            font-size: 1.1rem;
        }
        
        .exercise-timer {
            color: #ff9800;
        }
        
        .rest-timer {
            color: #4CAF50;
        }
        
        .complete-set-btn, .next-set-btn, .next-exercise-btn, .finish-btn {
            background: #2196F3;
            margin-top: 10px;
            padding: 45px 30px;
            font-size: 24px;
        }
        
        .complete-set-btn:hover, .next-set-btn:hover, .next-exercise-btn:hover, .finish-btn:hover {
            background: #1976D2;
        }
        
        .back-btn {
            background: #666;
            margin-bottom: 20px;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        .back-btn:hover {
            background: #555;
        }
        
        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .success {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            color: #ccc;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí™ Gym Tracker 
                <button class="settings-btn" onclick="showSetup()" title="GitHub Settings">‚öôÔ∏è</button>
            </h1>
        </div>
        
        <!-- GitHub Setup Screen -->
        <div class="setup-screen active">
            <div class="setup-form">
                <h2>GitHub Setup</h2>
                <p style="color: #ccc; margin-bottom: 20px;">
                    Connect to your GitHub repository to store workout data.
                </p>
                
                <div class="form-group">
                    <label for="github-username">GitHub Username:</label>
                    <input type="text" id="github-username" placeholder="your-username">
                </div>
                
                <div class="form-group">
                    <label for="github-repo">Repository Name:</label>
                    <input type="text" id="github-repo" placeholder="gym-tracker">
                </div>
                
                <div class="form-group">
                    <label for="github-token">Personal Access Token:</label>
                    <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                
                <button class="btn" id="connect-btn">Connect to GitHub</button>
                
                <div id="setup-status"></div>
            </div>
        </div>
        
        <!-- Workout Selection Screen -->
        <div class="workout-selection">
            <div class="last-workout" id="last-workout-info">
                <strong>Last Workout:</strong> <span id="last-workout-text">None recorded</span>
            </div>
            
            <h2 style="margin-bottom: 20px;">Select Today's Workout</h2>
            <div id="workout-options"></div>
        </div>
        
        <!-- Exercise Selection Screen -->
        <div class="exercise-selection">
            <button class="btn back-btn" onclick="showWorkoutSelection()">
                ‚Üê Back to Days
            </button>
            
            <h2 id="exercise-selection-title" style="margin-bottom: 20px;">Select Exercise</h2>
            <div id="exercise-options"></div>
            
            <button class="btn save-progress-btn" id="save-progress-btn" onclick="saveProgress()" style="background: #2196F3; margin-top: 20px; padding: 20px 30px; font-size: 20px;">
                üíæ Save Progress
            </button>
        </div>
        
        <!-- Workout Screen -->
        <div class="workout-screen">
            <button class="btn back-btn" onclick="backToExerciseSelection()">
                ‚Üê Back to Exercises
            </button>
            <div class="current-exercise">
                <div class="current-exercise-left">
                    <div class="exercise-name" id="current-exercise-name"></div>
                    <div class="exercise-info" id="current-exercise-info"></div>
                    <div class="sets-progress">
                        <div class="set-info" id="set-info"></div>
                    </div>
                </div>
                <div class="current-exercise-right">
                    <div class="exercise-weight" id="current-exercise-weight"></div>
                </div>
            </div>
                
                <div class="set-controls" id="set-controls">
                    <button class="btn complete-set-btn" id="complete-set-btn" onclick="completeSet()">
                        Mark Set 1 Done
                    </button>
                </div>
                
                <div class="timer" id="timer-section" style="display: none;">
                    <div class="timer-display" id="timer-display">00:00</div>
                    <div class="timer-label" id="timer-label">Rest Timer</div>
                </div>
                
                <button class="btn next-set-btn" id="next-set-btn" onclick="nextSet()" style="display: none;">
                    Next Set
                </button>
                
                <button class="btn next-exercise-btn" id="next-exercise-btn" onclick="backToExerciseSelection()" style="display: none;">
                    Back to Exercises
                </button>
                
                <button class="btn finish-btn" id="finish-btn" onclick="finishWorkout()" style="display: none;">
                    Finish Workout
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workoutData = null;
        let completedWorkouts = null;
        let currentSession = null;
        let selectedWorkoutId = null;
        let completedExercises = new Set();
        let currentExerciseIndex = 0;
        let currentSet = 0;
        let currentReps = 0;
        let timer = null;
        let timerSeconds = 0;
        let isExerciseTimer = false;
        
        // GitHub configuration
        let githubConfig = {
            username: '',
            repo: '',
            token: ''
        };
        
        // Initialize app
        window.onload = function() {
            // Add event listener for connect button
            document.getElementById('connect-btn').addEventListener('click', setupGitHub);
            
            loadGitHubConfig();
        };
        
        function loadGitHubConfig() {
            const saved = JSON.parse(sessionStorage.getItem('githubConfig') || '{}');
            
            if (saved.username && saved.repo && saved.token) {
                githubConfig = saved;
                loadWorkoutData();
            } else {
                showSetup();
            }
        }
        
        async function setupGitHub() {
            console.log('setupGitHub called');
            
            const username = document.getElementById('github-username').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const token = document.getElementById('github-token').value.trim();
            
            console.log('Username:', username);
            console.log('Repo:', repo);
            console.log('Token provided:', token ? 'yes' : 'no');
            
            if (!username || !repo || !token) {
                console.log('Missing fields - stopping');
                showStatus('setup-status', 'Please fill in all fields', 'error');
                return;
            }
            
            console.log('All fields provided, proceeding...');
            
            githubConfig = { username, repo, token };
            sessionStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            
            console.log('githubConfig username:', githubConfig.username);
            console.log('githubConfig repo:', githubConfig.repo);
            console.log('githubConfig token length:', githubConfig.token.length);
            
            showStatus('setup-status', 'Testing connection...', 'loading');
            
            // Simplified test - just try to load workout data directly
            try {
                console.log('About to call loadWorkoutData...');
                console.log('Current githubConfig username:', githubConfig.username);
                console.log('Current githubConfig repo:', githubConfig.repo);
                await loadWorkoutData();
                console.log('loadWorkoutData completed successfully');
                showStatus('setup-status', 'Connected successfully!', 'success');
                setTimeout(() => {
                    showWorkoutSelection();
                }, 1000);
            } catch (error) {
                console.error('loadWorkoutData failed:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                showStatus('setup-status', `Connection failed: ${error.message}`, 'error');
            }
        }
        
        function loadGitHubConfig() {
            const saved = JSON.parse(sessionStorage.getItem('githubConfig') || '{}');
            
            if (saved.username && saved.repo && saved.token) {
                githubConfig = saved;
                loadWorkoutData();
            } else {
                showSetup();
            }
        }
        
        function showSetup() {
            document.querySelector('.setup-screen').classList.add('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function showWorkoutSelection() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.add('active');
            document.querySelector('.exercise-selection').classList.remove('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function showExerciseSelection() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.exercise-selection').classList.add('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function showWorkoutScreen() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.exercise-selection').classList.remove('active');
            document.querySelector('.workout-screen').classList.add('active');
        }
        
        function backToExerciseSelection() {
            // Stop any active timers
            stopTimer();
            
            // Clear current exercise state
            currentSession = null;
            currentExerciseIndex = 0;
            currentSet = 0;
            currentReps = 0;
            
            // Refresh exercise list to show completed status
            displayExerciseOptions();
            
            // Show exercise selection screen
            showExerciseSelection();
        }
        
        async function saveProgress() {
            const saveProgressBtn = document.getElementById('save-progress-btn');
            const isCompleteDay = saveProgressBtn.textContent.includes('Complete Day');
            
            // Create a session with all completed exercises
            const session = {
                date: new Date().toISOString(),
                workoutId: selectedWorkoutId,
                exercises: []
            };
            
            // Add all completed exercises to the session
            const workout = workoutData.workouts[selectedWorkoutId];
            completedExercises.forEach(exerciseIndex => {
                const exercise = workout.exercises[exerciseIndex];
                const exerciseRecord = {
                    name: exercise.name,
                    sets: []
                };
                
                // Add all sets for this exercise
                for (let setNum = 0; setNum < exercise.sets; setNum++) {
                    exerciseRecord.sets.push({
                        reps: exercise.targetReps,
                        weight: exercise.currentWeight || 0
                    });
                }
                
                session.exercises.push(exerciseRecord);
            });
            
            // Save the session
            completedWorkouts.sessions.push(session);
            await saveCompletedWorkouts();
            
            // Update last workout display
            displayLastWorkout();
            
            if (isCompleteDay) {
                // If completing full day, clear state and return to day selection
                completedExercises.clear();
                selectedWorkoutId = null;
                showWorkoutSelection();
                alert('üéâ Day completed and saved!');
            } else {
                // If just saving progress, stay on exercise page
                alert('üíæ Progress saved!');
            }
        }
        
        function backToWorkoutSelection() {
            // Stop any active timers
            stopTimer();
            
            // Clear all workout state
            currentSession = null;
            selectedWorkoutId = null;
            completedExercises.clear();
            currentExerciseIndex = 0;
            currentSet = 0;
            currentReps = 0;
            
            // Show workout selection screen
            showWorkoutSelection();
        }
        
        async function setupGitHub() {
            console.log('setupGitHub called');
            
            const username = document.getElementById('github-username').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const token = document.getElementById('github-token').value.trim();
            
            console.log('Username:', username);
            console.log('Repo:', repo);
            console.log('Token provided:', token ? 'yes' : 'no');
            
            if (!username || !repo || !token) {
                console.log('Missing fields - stopping');
                showStatus('setup-status', 'Please fill in all fields', 'error');
                return;
            }
            
            console.log('All fields provided, proceeding...');
            
            githubConfig = { username, repo, token };
            sessionStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            
            console.log('githubConfig username:', githubConfig.username);
            console.log('githubConfig repo:', githubConfig.repo);
            console.log('githubConfig token length:', githubConfig.token.length);
            
            showStatus('setup-status', 'Testing connection...', 'loading');
            
            // Simplified test - just try to load workout data directly
            try {
                console.log('About to call loadWorkoutData...');
                console.log('Current githubConfig username:', githubConfig.username);
                console.log('Current githubConfig repo:', githubConfig.repo);
                await loadWorkoutData();
                console.log('loadWorkoutData completed successfully');
                showStatus('setup-status', 'Connected successfully!', 'success');
                setTimeout(() => {
                    showWorkoutSelection();
                }, 1000);
            } catch (error) {
                console.error('loadWorkoutData failed:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                showStatus('setup-status', `Connection failed: ${error.message}`, 'error');
            }
        }
        
        // Development mode detection
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        async function loadWorkoutData() {
            if (isDevelopment) {
                // Mock workout data for local development
                console.log('üöß Development mode: Using mock data');
                workoutData = {
                    "workouts": {
                        "day1-upper": {
                            "name": "Day 1: Full Body Emphasis on Upper Body",
                            "exercises": [
                                {"name": "Chest Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 85, "restTime": 60},
                                {"name": "Seated Row (machine)", "sets": 3, "targetReps": 15, "currentWeight": 70, "restTime": 60},
                                {"name": "Shoulder Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 45, "restTime": 60},
                                {"name": "Leg Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 180, "restTime": 60},
                                {"name": "Plank", "sets": 3, "targetReps": 1, "duration": 30, "restTime": 60},
                                {"name": "Standing Cable Rotations", "sets": 3, "targetReps": 15, "currentWeight": 25, "restTime": 60}
                            ]
                        },
                        "day2-lower": {
                            "name": "Day 2: Full Body Emphasis on Lower Body",
                            "exercises": [
                                {"name": "Leg Extensions (machine)", "sets": 3, "targetReps": 15, "currentWeight": 60, "restTime": 60},
                                {"name": "Leg Curls (machine)", "sets": 3, "targetReps": 15, "currentWeight": 55, "restTime": 60},
                                {"name": "Lat Pulldown (machine)", "sets": 3, "targetReps": 15, "currentWeight": 75, "restTime": 60},
                                {"name": "Cable Tricep Pushdown", "sets": 3, "targetReps": 15, "currentWeight": 40, "restTime": 60},
                                {"name": "Seated Back Extension", "sets": 3, "targetReps": 15, "currentWeight": 35, "restTime": 60},
                                {"name": "Wall Sit", "sets": 3, "targetReps": 1, "duration": 30, "restTime": 60}
                            ]
                        },
                        "day3-balance": {
                            "name": "Day 3: Full Body Balance",
                            "exercises": [
                                {"name": "Chest Fly (machine)", "sets": 3, "targetReps": 15, "currentWeight": 50, "restTime": 60},
                                {"name": "Cable Face Pull", "sets": 3, "targetReps": 15, "currentWeight": 30, "restTime": 60},
                                {"name": "Lateral Raise (machine or light dumbbells)", "sets": 3, "targetReps": 15, "currentWeight": 15, "restTime": 60},
                                {"name": "Seated Leg Adduction/Abduction", "sets": 3, "targetReps": 15, "currentWeight": 45, "restTime": 60},
                                {"name": "Standing Cable Rotations", "sets": 3, "targetReps": 15, "currentWeight": 25, "restTime": 60},
                                {"name": "Assisted Pull-ups (machine)", "sets": 3, "targetReps": 15, "currentWeight": 80, "restTime": 60}
                            ]
                        }
                    }
                };
                
                completedWorkouts = {
                    "sessions": [
                        {
                            "date": "2025-08-01T18:30:00.000Z",
                            "workoutId": "day1-upper",
                            "exercises": [
                                {
                                    "name": "Chest Press (machine)",
                                    "sets": [
                                        {"reps": 15, "weight": 85},
                                        {"reps": 15, "weight": 85},
                                        {"reps": 15, "weight": 85}
                                    ]
                                }
                            ]
                        }
                    ]
                };
                
                displayWorkoutOptions();
                displayLastWorkout();
                showWorkoutSelection();
                return;
            }
            
            // Production mode: actual GitHub API calls
            console.log('üåê Production mode: Using GitHub API');
            console.log('=== ENTERING loadWorkoutData ===');
            console.log('githubConfig available:', typeof githubConfig);
            console.log('githubConfig.username:', githubConfig.username);
            console.log('githubConfig.repo:', githubConfig.repo);
            
            try {
                // Load workouts.json
                console.log('Loading workouts.json...');
                const workoutsUrl = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts.json`;
                console.log('Fetching URL:', workoutsUrl);
                
                const workoutsResponse = await fetch(workoutsUrl, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!workoutsResponse.ok) {
                    if (workoutsResponse.status === 404) {
                        console.log('workouts.json not found, creating initial structure...');
                        // Create initial workout structure
                        workoutData = {
                            workouts: {
                                "upper-body": {
                                    "name": "Upper Body Emphasis",
                                    "exercises": [
                                        {"name": "Chest Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Seated Row (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Shoulder Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Leg Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Plank", "sets": 3, "targetReps": 1, "duration": 30, "restTime": 60},
                                        {"name": "Standing Cable Rotations", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60}
                                    ]
                                },
                                "lower-body": {
                                    "name": "Lower Body Emphasis",
                                    "exercises": [
                                        {"name": "Leg Extensions (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Leg Curls (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Lat Pulldown (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Cable Tricep Pushdown", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Seated Back Extension", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Wall Sit", "sets": 3, "targetReps": 1, "duration": 30, "restTime": 60}
                                    ]
                                },
                                "balance": {
                                    "name": "Full Body Balance",
                                    "exercises": [
                                        {"name": "Chest Fly (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Cable Face Pull", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Lateral Raise", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Seated Leg Adduction/Abduction", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Standing Cable Rotations", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                                        {"name": "Assisted Pull-ups", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60}
                                    ]
                                }
                            }
                        };
                        await saveWorkoutData();
                    } else {
                        throw new Error(`Failed to load workouts.json: ${workoutsResponse.status}`);
                    }
                } else {
                    console.log('Successfully loaded workouts.json');
                    const workoutsData = await workoutsResponse.json();
                    workoutData = JSON.parse(atob(workoutsData.content));
                }

                // Load workouts-completed.json  
                console.log('Loading workouts-completed.json...');
                const completedUrl = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts-completed.json`;
                
                const completedResponse = await fetch(completedUrl, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!completedResponse.ok) {
                    if (completedResponse.status === 404) {
                        console.log('workouts-completed.json not found, creating empty history...');
                        completedWorkouts = { sessions: [] };
                        await saveCompletedWorkouts();
                    } else {
                        throw new Error(`Failed to load workouts-completed.json: ${completedResponse.status}`);
                    }
                } else {
                    console.log('Successfully loaded workouts-completed.json');
                    const completedData = await completedResponse.json();
                    completedWorkouts = JSON.parse(atob(completedData.content));
                }
                
                displayWorkoutOptions();
                displayLastWorkout();
                showWorkoutSelection();
                
            } catch (error) {
                console.error('Full error:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error(`Network error: Unable to connect to GitHub. Check your internet connection and make sure you can access github.com`);
                } else {
                    throw new Error(`Failed to load workout data: ${error.message}`);
                }
            }
        }
        
        async function saveWorkoutData() {
            if (isDevelopment) {
                // Save to localStorage in development
                localStorage.setItem('workoutData', JSON.stringify(workoutData));
                console.log('Workout data saved to localStorage');
                return;
            }
            
            // In production, save to GitHub (workouts.json only - no sessions)
            // This function now only saves workout definitions, not session history
            console.log('Saving workout definitions to GitHub...');
            // Note: GitHub API save implementation would go here
        }
        
        async function saveCompletedWorkouts() {
            if (isDevelopment) {
                // Save to localStorage in development
                localStorage.setItem('completedWorkouts', JSON.stringify(completedWorkouts));
                console.log('Completed workouts saved to localStorage');
                return;
            }
            
            // In production, save to GitHub (workouts-completed.json)
            console.log('Saving completed workouts to GitHub...');
            
            try {
                const content = btoa(JSON.stringify(completedWorkouts, null, 2));
                const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts-completed.json`;
                
                // First, get the current file to get its SHA (required for updates)
                let sha = null;
                try {
                    const currentResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (currentResponse.ok) {
                        const currentData = await currentResponse.json();
                        sha = currentData.sha;
                    }
                } catch (e) {
                    // File doesn't exist yet, that's ok
                }
                
                // Now save the file
                const body = {
                    message: `Update workout progress: ${new Date().toISOString()}`,
                    content: content
                };
                
                if (sha) {
                    body.sha = sha; // Required for updates
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                console.log('Completed workouts saved to GitHub successfully');
                
            } catch (error) {
                console.error('Failed to save to GitHub:', error);
                throw new Error(`Failed to save progress: ${error.message}`);
            }
        }
        
        function addExportButton() {
            if (!document.getElementById('export-btn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'export-btn';
                exportBtn.className = 'btn';
                exportBtn.style.background = '#ff9800';
                exportBtn.style.marginTop = '20px';
                exportBtn.textContent = 'üì§ Export Data';
                exportBtn.onclick = exportData;
                
                const settingsBtn = document.querySelector('.workout-selection button[onclick="showSetup()"]');
                settingsBtn.parentNode.insertBefore(exportBtn, settingsBtn);
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(workoutData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `workout-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        function displayWorkoutOptions() {
            const container = document.getElementById('workout-options');
            container.innerHTML = '';
            
            Object.keys(workoutData.workouts).forEach(workoutId => {
                const workout = workoutData.workouts[workoutId];
                const div = document.createElement('div');
                div.className = 'workout-option';
                div.onclick = () => startWorkout(workoutId);
                
                div.innerHTML = `
                    <div class="workout-title">${workout.name}</div>
                    <div class="exercise-count">${workout.exercises.length} exercises</div>
                `;
                
                container.appendChild(div);
            });
        }
        
        function displayLastWorkout() {
            const lastWorkoutText = document.getElementById('last-workout-text');
            
            if (!completedWorkouts || completedWorkouts.sessions.length === 0) {
                lastWorkoutText.textContent = 'None recorded';
                return;
            }
            
            const lastSession = completedWorkouts.sessions[completedWorkouts.sessions.length - 1];
            const date = new Date(lastSession.date);
            const workoutName = workoutData.workouts[lastSession.workoutId]?.name || 'Unknown workout';
            
            lastWorkoutText.textContent = `${workoutName} on ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        }
        
        function startWorkout(workoutId) {
            selectedWorkoutId = workoutId;
            completedExercises.clear(); // Clear completed exercises for new workout
            const workout = workoutData.workouts[workoutId];
            
            // Update exercise selection title
            document.getElementById('exercise-selection-title').textContent = workout.name;
            
            // Display exercises for selection
            displayExerciseOptions();
            
            showExerciseSelection();
        }
        
        function displayExerciseOptions() {
            const workout = workoutData.workouts[selectedWorkoutId];
            const container = document.getElementById('exercise-options');
            container.innerHTML = '';
            
            workout.exercises.forEach((exercise, index) => {
                const div = document.createElement('div');
                div.className = completedExercises.has(index) ? 'exercise-option completed' : 'exercise-option';
                div.onclick = () => startExercise(index);
                
                // Left column: exercise name and details
                let details = `${exercise.sets} sets`;
                if (!exercise.duration) {
                    details += ` ‚Ä¢ ${exercise.targetReps} reps`;
                }
                
                // Right column: weight or duration
                let rightColumn = '';
                if (exercise.duration) {
                    rightColumn = `<div class="exercise-weight-display">${exercise.duration}s</div>`;
                } else if (exercise.currentWeight > 0) {
                    rightColumn = `<div class="exercise-weight-display">${exercise.currentWeight} lbs</div>`;
                }
                
                div.innerHTML = `
                    <div class="exercise-left">
                        <div class="exercise-name-option">${exercise.name}</div>
                        <div class="exercise-details">${details}</div>
                    </div>
                    <div class="exercise-right">
                        ${rightColumn}
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Update button text based on completion status
            const saveProgressBtn = document.getElementById('save-progress-btn');
            if (completedExercises.size === workout.exercises.length) {
                saveProgressBtn.textContent = 'üéâ Complete Day';
                saveProgressBtn.style.background = '#4CAF50';
            } else {
                saveProgressBtn.textContent = 'üíæ Save Progress';
                saveProgressBtn.style.background = '#2196F3';
            }
        }
        
        function startExercise(exerciseIndex) {
            currentSession = {
                date: new Date().toISOString(),
                workoutId: selectedWorkoutId,
                exercises: []
            };
            
            currentExerciseIndex = exerciseIndex;
            currentSet = 0;
            currentReps = 0;
            
            showWorkoutScreen();
            displayCurrentExercise();
        }
        
        function displayCurrentExercise() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const exercise = workout.exercises[currentExerciseIndex];
            
            document.getElementById('current-exercise-name').textContent = exercise.name;
            
            // Display weight or duration prominently
            const weightElement = document.getElementById('current-exercise-weight');
            if (exercise.duration) {
                // For time-based exercises, show duration prominently
                weightElement.textContent = `${exercise.duration}s hold`;
                weightElement.style.display = 'block';
            } else if (exercise.currentWeight > 0) {
                // For weight-based exercises, show weight prominently
                weightElement.textContent = `${exercise.currentWeight} lbs`;
                weightElement.style.display = 'block';
            } else {
                weightElement.style.display = 'none';
            }
            
            let info = `Set ${currentSet + 1} of ${exercise.sets}`;
            if (!exercise.duration) {
                info += ` ‚Ä¢ Target: ${exercise.targetReps} reps`;
            }
            
            document.getElementById('current-exercise-info').textContent = info;
            document.getElementById('set-info').textContent = ``;
            
            // Update button text based on exercise type
            const completeSetBtn = document.getElementById('complete-set-btn');
            if (exercise.duration) {
                completeSetBtn.textContent = `Start Set ${currentSet + 1}`;
                completeSetBtn.onclick = () => startTimedSet();
            } else {
                completeSetBtn.textContent = `Mark Set ${currentSet + 1} Done`;
                completeSetBtn.onclick = () => completeSet();
            }
            
            // Hide all control buttons initially
            document.getElementById('next-set-btn').style.display = 'none';
            document.getElementById('next-exercise-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = 'none';
            
            // Show set controls
            document.getElementById('set-controls').style.display = 'block';
            
            stopTimer();
        }
        
        function startTimedSet() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const exercise = workout.exercises[currentExerciseIndex];
            
            // Hide the start button
            document.getElementById('set-controls').style.display = 'none';
            
            // Start the exercise timer (countdown)
            startExerciseTimer(exercise.duration);
        }
        
        function completeSet() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const exercise = workout.exercises[currentExerciseIndex];
            
            // Record the completed set
            recordSet();
            
            // Hide the complete set button
            document.getElementById('set-controls').style.display = 'none';
            
            // Start rest timer
            startRestTimer(exercise.restTime);
            
            // Show appropriate next action button
            if (currentSet < exercise.sets - 1) {
                document.getElementById('next-set-btn').style.display = 'block';
            } else {
                // Exercise is complete - mark it as completed
                completedExercises.add(currentExerciseIndex);
                document.getElementById('next-exercise-btn').style.display = 'block';
            }
        }
        
        
        function nextSet() {
            currentSet++;
            currentReps = 0;
            displayCurrentExercise();
        }
        
        function nextExercise() {
            currentExerciseIndex++;
            currentSet = 0;
            currentReps = 0;
            displayCurrentExercise();
        }
        
        function recordSet() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const exercise = workout.exercises[currentExerciseIndex];
            
            // Find or create exercise record in current session
            let exerciseRecord = currentSession.exercises.find(e => e.name === exercise.name);
            if (!exerciseRecord) {
                exerciseRecord = {
                    name: exercise.name,
                    sets: []
                };
                currentSession.exercises.push(exerciseRecord);
            }
            
            // Add the completed set with target reps
            exerciseRecord.sets.push({
                reps: exercise.targetReps,
                weight: exercise.currentWeight || 0
            });
        }
        
        async function finishWorkout() {
            // Save session to completed workouts
            completedWorkouts.sessions.push(currentSession);
            
            // Save completed workouts history
            await saveCompletedWorkouts();
            
            // Return to workout selection
            showWorkoutSelection();
            displayLastWorkout();
            
            alert('Workout completed and saved!');
        }
        
        function startRestTimer(seconds) {
            startTimer(seconds, false, 'Rest Timer');
        }
        
        function startExerciseTimer(seconds) {
            startTimer(seconds, true, 'Exercise Timer');
        }
        
        function startTimer(seconds, isExercise, label) {
            stopTimer();
            
            timerSeconds = seconds;
            isExerciseTimer = isExercise;
            
            const timerSection = document.getElementById('timer-section');
            const timerDisplay = document.getElementById('timer-display');
            const timerLabel = document.getElementById('timer-label');
            
            timerLabel.textContent = label;
            timerSection.style.display = 'block';
            
            if (isExercise) {
                timerSection.className = 'timer exercise-timer';
            } else {
                timerSection.className = 'timer rest-timer';
            }
            
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    stopTimer();
                    if (isExercise) {
                        // Exercise timer finished, show complete set button
                        onExerciseTimerComplete();
                    }
                }
            }, 1000);
        }
        
        function onExerciseTimerComplete() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const exercise = workout.exercises[currentExerciseIndex];
            
            // Show the complete set button
            const completeSetBtn = document.getElementById('complete-set-btn');
            completeSetBtn.textContent = `Mark Set ${currentSet + 1} Done`;
            completeSetBtn.onclick = () => completeSet();
            document.getElementById('set-controls').style.display = 'block';
            
            // Update status text
            document.getElementById('set-info').textContent = `Set complete! Click to finish`;
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
        }
        
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            document.getElementById('timer-section').style.display = 'none';
        }
        
        function showOfflineOption() {
            document.getElementById('offline-option').style.display = 'block';
        }
        
        function useOfflineMode() {
            // Initialize with default workout data
            workoutData = {
                "workouts": {
                    "day1-upper": {
                        "name": "Day 1: Full Body Emphasis on Upper Body",
                        "exercises": [
                            {"name": "Chest Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Seated Row (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Shoulder Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Leg Press (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Plank", "sets": 3, "targetReps": 1, "duration": 30, "restTime": 60},
                            {"name": "Standing Cable Rotations", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60}
                        ]
                    },
                    "day2-lower": {
                        "name": "Day 2: Full Body Emphasis on Lower Body",
                        "exercises": [
                            {"name": "Leg Extensions (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Leg Curls (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Lat Pulldown (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Cable Tricep Pushdown", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Seated Back Extension", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Wall Sit", "sets": 3, "targetReps": 1, "duration": 30, "restTime": 60}
                        ]
                    },
                    "day3-balance": {
                        "name": "Day 3: Full Body Balance",
                        "exercises": [
                            {"name": "Chest Fly (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Cable Face Pull", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Lateral Raise (machine or light dumbbells)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Seated Leg Adduction/Abduction", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Standing Cable Rotations", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60},
                            {"name": "Assisted Pull-ups (machine)", "sets": 3, "targetReps": 15, "currentWeight": 0, "restTime": 60}
                        ]
                    }
                }
            };
            
            // Initialize empty completed workouts
            completedWorkouts = { sessions: [] };
            
            // Mark as offline mode
            sessionStorage.setItem('offlineMode', 'true');
            
            displayWorkoutOptions();
            displayLastWorkout();
            showWorkoutSelection();
            
            // Add export button to workout selection
            addExportButton();
        }
        
        function addExportButton() {
            if (!document.getElementById('export-btn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'export-btn';
                exportBtn.className = 'btn';
                exportBtn.style.background = '#ff9800';
                exportBtn.style.marginTop = '20px';
                exportBtn.textContent = 'üì§ Export Data';
                exportBtn.onclick = exportData;
                
                document.querySelector('.workout-selection').appendChild(exportBtn);
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(workoutData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `workout-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>