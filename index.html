<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; connect-src 'self' https://api.github.com; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src 'self' data:;">
    <title>Gym Tracker</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2rem;
            color: #4CAF50;
            margin-bottom: 10px;
            position: relative;
        }
        
        .settings-btn {
	    position: absolute;
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 10px;
            padding: 5px;
            border-radius: 3px;
            transition: color 0.2s, background-color 0.2s;
        }
        
        .settings-btn:hover {
            color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .edit-mode-btn {
            background: none;
            border: 1px solid #666;
            color: #ccc;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
            vertical-align: top;
            position: relative;
            top: 7px;
        }
        
        .edit-mode-btn:hover {
            color: #fff;
            border-color: #888;
        }
        
        .edit-mode-btn.active {
            background: #ff9800;
            border-color: #ff9800;
            color: #fff;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .setup-screen, .workout-selection, .exercise-selection, .workout-screen {
            display: none;
        }
        
        .setup-screen.active, .workout-selection.active, .exercise-selection.active, .workout-screen.active {
            display: block;
        }
        
        .setup-form {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 16px;
        }
        
        .btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #45a049;
        }
        
        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .last-workout {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }
        
        .workout-option {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            position: relative;
        }
        
        .workout-option:hover {
            border-color: #4CAF50;
        }
        
        .workout-edit-btn {
            position: absolute;
            top: -15px;
            right: -10px;
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0;
            border-radius: 0;
            transition: color 0.2s, background-color 0.2s;
            z-index: 10;
            width: 20px;
            height: 25px;
            overflow: hidden;
        }
        
        .workout-edit-btn:hover {
            color: #ff9800;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .workout-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .exercise-count {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .exercise-option {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .exercise-option:hover {
            border-color: #4CAF50;
        }
        
        .exercise-left {
            flex: 1;
        }
        
        .exercise-right {
            flex: 0 0 auto;
            text-align: right;
            margin-left: 20px;
        }
        
        .exercise-name-option {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .exercise-details {
            color: #ccc;
            font-size: 0.9rem;
        }
        
        .exercise-weight-display {
            color: #ff9800;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .exercise-weight-display .sets-count {
            font-size: 1.2rem;
        }
        
        .exercise-option.completed {
            border: 2px solid #4CAF50;
            background: #1a3d1a;
        }
        
        .exercise-option.completed::after {
            content: "✓";
            position: absolute;
            top: 10px;
            right: 15px;
            color: #4CAF50;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .exercise-option {
            position: relative;
        }
        
        .exercise-edit-btn {
            position: absolute;
            top: -15px;
            right: -10px;
            background: none;
            border: none;
            color: #ccc;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0;
            border-radius: 0;
            transition: color 0.2s, background-color 0.2s;
            z-index: 10;
            width: 20px;
            height: 25px;
            overflow: hidden;
        }
        
        .exercise-edit-btn:hover {
            color: #ff9800;
            background-color: rgba(255, 152, 0, 0.1);
        }
        
        .exercise-edit-screen {
            display: none;
        }
        
        .exercise-edit-screen.active {
            display: block;
        }
        
        .exercise-edit-form {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .exercise-edit-form h2 {
            color: #4CAF50;
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 16px;
        }
        
        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #444;
            border-radius: 5px;
            background: #333;
            color: white;
            font-size: 16px;
            resize: vertical;
            min-height: 60px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            flex: 1;
            transition: background-color 0.2s;
        }
        
        .btn-secondary:hover {
            background: #555;
        }
        
        /* Workout Edit Screen Styles */
        .workout-edit-screen {
            display: none;
        }
        
        .workout-edit-screen.active {
            display: block;
        }
        
        .exercise-section {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .exercise-section h3 {
            color: #4CAF50;
            margin-bottom: 15px;
        }
        
        .current-exercises {
            min-height: 100px;
            padding: 10px;
            border: 2px dashed #444;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .current-exercises.drag-over {
            border-color: #4CAF50;
            background-color: rgba(76, 175, 80, 0.1);
        }
        
        .workout-exercise-item {
            background: #333;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: grab;
            border: 2px solid transparent;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }
        
        .workout-exercise-item:hover {
            background: #3a3a3a;
            border-color: #4CAF50;
        }
        
        .workout-exercise-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(2deg);
        }
        
        .workout-exercise-item .drag-handle {
            color: #888;
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .workout-exercise-item .exercise-info {
            flex: 1;
        }
        
        .workout-exercise-item .exercise-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .workout-exercise-item .exercise-sets {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .workout-exercise-item .remove-btn {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .available-exercise-item {
            background: #333;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .available-exercise-item:hover {
            background: #3a3a3a;
            border-color: #2196F3;
        }
        
        .available-exercise-item .exercise-name {
            font-weight: bold;
            margin-bottom: 2px;
        }
        
        .available-exercise-item .exercise-details {
            font-size: 0.9rem;
            color: #ccc;
        }
        
        .current-exercise {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .current-exercise-left {
            flex: 1;
        }
        
        .current-exercise-right {
            flex: 0 0 auto;
            text-align: right;
            margin-left: 20px;
        }
        
        .exercise-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #4CAF50;
        }
        
        .exercise-weight {
            font-size: 2rem;
            font-weight: bold;
            color: #ff9800;
        }
        
        .sets-count {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
        }
        
        .exercise-info {
            margin-bottom: 15px;
            color: #ccc;
        }
        
        .sets-progress {
            margin-bottom: 20px;
        }
        
        .set-info {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .rep-counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .rep-button {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #4CAF50;
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rep-button:hover {
            background: #45a049;
            transform: scale(1.05);
        }
        
        .rep-button:disabled {
            background: #666;
            transform: none;
        }
        
        .rep-count {
            font-size: 2rem;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
        }
        
        .timer {
            text-align: center;
            margin-top: 30px;
            margin-bottom: 20px;
        }
        
        .timer-display {
            font-size: 4rem;
            font-weight: bold;
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .timer-label {
            color: #ccc;
            font-size: 1.1rem;
        }
        
        .exercise-timer .timer-display {
            color: #4CAF50;
        }
        
        .rest-timer .timer-display {
            color: #4CAF50;
        }
        
        .timer-expired {
            animation: pulse 1s ease-in-out infinite !important;
            color: #f44336 !important;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                background-color: rgba(244, 67, 54, 0.2);
            }
            50% {
                transform: scale(1.2);
                background-color: rgba(244, 67, 54, 0.8);
                color: white !important;
            }
            100% {
                transform: scale(1);
                background-color: rgba(244, 67, 54, 0.2);
            }
        }
        
        .complete-set-btn, .next-set-btn, .next-exercise-btn, .finish-btn {
            background: #2196F3;
            margin-top: 10px;
            padding: 45px 30px;
            font-size: 24px;
        }
        
        .complete-set-btn:hover, .next-set-btn:hover, .next-exercise-btn:hover, .finish-btn:hover {
            background: #1976D2;
        }
        
        .complete-set-btn:disabled, .next-set-btn:disabled, .next-exercise-btn:disabled, .finish-btn:disabled {
            background: #ccc;
            color: #888;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .back-btn {
            background: #666;
            margin-bottom: 20px;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        .back-btn:hover {
            background: #555;
        }
        
        .error {
            background: #f44336;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .success {
            background: #4CAF50;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            color: #ccc;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gym Tracker 
                <button class="edit-mode-btn" id="edit-mode-btn" onclick="toggleEditMode()">Edit</button>
                <button class="settings-btn" id="settings-btn" onclick="showSetup()" title="GitHub Settings" style="display: none;">⚙️</button>
            </h1>
        </div>
        
        <!-- GitHub Setup Screen -->
        <div class="setup-screen active">
            <div class="setup-form">
                <h2>GitHub Setup</h2>
                <p style="color: #ccc; margin-bottom: 20px;">
                    Connect to your GitHub repository to store workout data.
                </p>
                
                <div class="form-group">
                    <label for="github-username">GitHub Username:</label>
                    <input type="text" id="github-username" placeholder="your-username">
                </div>
                
                <div class="form-group">
                    <label for="github-repo">Repository Name:</label>
                    <input type="text" id="github-repo" placeholder="gym-tracker">
                </div>
                
                <div class="form-group">
                    <label for="github-token">Personal Access Token:</label>
                    <input type="password" id="github-token" placeholder="ghp_xxxxxxxxxxxx">
                </div>
                
                <button class="btn" id="connect-btn">Connect to GitHub</button>
                
                <div id="setup-status"></div>
            </div>
        </div>
        
        <!-- Workout Selection Screen -->
        <div class="workout-selection">
            <div class="last-workout" id="last-workout-info">
                <strong>Last Workout:</strong> <span id="last-workout-text">None recorded</span>
            </div>
            
            <h2 style="margin-bottom: 20px;">Select Today's Workout</h2>
            <div id="workout-options"></div>
        </div>
        
        <!-- Exercise Selection Screen -->
        <div class="exercise-selection">
            <button class="btn back-btn" onclick="showWorkoutSelection()">
                ← Back to Days
            </button>
            
            <h2 id="exercise-selection-title" style="margin-bottom: 20px;">Select Exercise</h2>
            <div id="exercise-options"></div>
            
            <button class="btn save-progress-btn" id="save-progress-btn" onclick="saveProgress()" style="background: #2196F3; margin-top: 20px; padding: 20px 30px; font-size: 20px;">
                Save Progress
            </button>
        </div>
        
        <!-- Workout Edit Screen -->
        <div class="workout-edit-screen">
            <button class="btn back-btn" onclick="cancelEditWorkout()">
                ← Back to Days
            </button>
            
            <h2 id="workout-edit-title">Edit Workout</h2>
            
            <div class="exercise-section">
                <h3>Workout Name</h3>
                <div class="form-group">
                    <input type="text" id="edit-workout-name" placeholder="Workout name" style="width: 100%; padding: 12px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; font-size: 16px; margin-bottom: 15px;">
                </div>
            </div>
            
            <div class="exercise-section">
                <h3>Exercises in this workout</h3>
                <div class="current-exercises" id="current-exercises">
                    <!-- Current workout exercises will be populated here -->
                </div>
            </div>
            
            <div class="exercise-section">
                <h3>Available exercises</h3>
                <div id="available-exercises">
                    <!-- Available exercises will be populated here -->
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn-secondary" onclick="cancelEditWorkout()">Cancel</button>
                <button class="btn-secondary" onclick="saveWorkoutEdit()" style="background: #4CAF50;">Save Changes</button>
            </div>
        </div>

        <!-- Exercise Edit Screen -->
        <div class="exercise-edit-screen">
            <button class="btn back-btn" onclick="cancelEditExercise()">
                ← Cancel
            </button>
            
            <div class="exercise-edit-form">
                <h2 id="edit-exercise-title">Edit Exercise</h2>
                
                <div class="form-group">
                    <label for="edit-exercise-name">Exercise Name:</label>
                    <input type="text" id="edit-exercise-name" placeholder="Exercise name">
                </div>
                
                <div class="form-group" id="edit-exercise-type-group" style="display: none;">
                    <label for="edit-exercise-type">Exercise Type:</label>
                    <select id="edit-exercise-type" style="width: 100%; padding: 12px; border: 1px solid #444; border-radius: 5px; background: #333; color: white; font-size: 16px;" onchange="toggleDurationField()">
                        <option value="strength">Strength (reps-based)</option>
                        <option value="isometric">Isometric (time-based)</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-current-weight">Current Weight (lbs):</label>
                        <input type="number" id="edit-current-weight" min="0" step="5" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label for="edit-default-sets">Default Sets:</label>
                        <input type="number" id="edit-default-sets" min="1" max="10" placeholder="3">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-default-reps">Default Target Reps:</label>
                        <input type="number" id="edit-default-reps" min="1" max="50" placeholder="12">
                    </div>
                    <div class="form-group">
                        <label for="edit-rest-time">Rest Time (seconds):</label>
                        <input type="number" id="edit-rest-time" min="30" max="300" step="15" placeholder="60">
                    </div>
                </div>
                
                <div class="form-group" id="edit-duration-group" style="display: none;">
                    <label for="edit-default-duration">Default Duration (seconds):</label>
                    <input type="number" id="edit-default-duration" min="5" max="300" step="5" placeholder="30">
                </div>
                
                <div class="form-group">
                    <label for="edit-notes">Notes:</label>
                    <textarea id="edit-notes" placeholder="Exercise notes or instructions..."></textarea>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn-secondary" onclick="cancelEditExercise()">Cancel</button>
                <button class="btn-secondary" onclick="saveExerciseEdit()" style="background: #4CAF50;">Save Changes</button>
            </div>
        </div>

        <!-- Workout Screen -->
        <div class="workout-screen">
            <button class="btn back-btn" onclick="backToExerciseSelection()">
                ← Back to Exercises
            </button>
            <div class="current-exercise">
                <div class="current-exercise-left">
                    <div class="exercise-name" id="current-exercise-name"></div>
                    <div class="exercise-info" id="current-exercise-info"></div>
                    <div class="sets-progress">
                        <div class="set-info" id="set-info"></div>
                    </div>
                </div>
                <div class="current-exercise-right">
                    <div class="exercise-weight" id="current-exercise-weight"></div>
                </div>
            </div>
                
                <button class="btn complete-set-btn" id="complete-set-btn" onclick="completeSet()">
                    Mark Set 1 Done
                </button>
                
                <button class="btn next-set-btn" id="next-set-btn" onclick="nextSet()" style="display: none;">
                    Next Set
                </button>
                
                <button class="btn next-exercise-btn" id="next-exercise-btn" onclick="backToExerciseSelection()" style="display: none;">
                    Back to Exercises
                </button>
                
                <button class="btn finish-btn" id="finish-btn" onclick="finishWorkout()" style="display: none;">
                    Finish Workout
                </button>
                
                <div class="timer" id="timer-section" style="display: none;">
                    <div class="timer-display" id="timer-display">00:00</div>
                    <div class="timer-label" id="timer-label">Rest Timer</div>
                </div>
                
                <div id="next-exercise-preview" style="display: none;">
                    <div style="margin: 20px 0 10px 0; color: #ccc; font-size: 1.1rem;">Next Exercise:</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let workoutData = null;
        let completedWorkouts = null;
        let currentSession = null;
        let selectedWorkoutId = null;
        let completedExercises = new Set();
        let currentExerciseIndex = 0;
        let currentSet = 0;
        let currentReps = 0;
        let timer = null;
        let timerSeconds = 0;
        let isExerciseTimer = false;
        let editModeEnabled = false;
        
        // Audio context for beep sounds
        let audioContext = null;
        let beepTimer = null;
        
        function initAudioContext() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.log('Web Audio API not supported');
            }
        }
        
        function playBeepCycle() {
            if (!audioContext) {
                initAudioContext();
            }
            
            if (!audioContext) return;
            
            // Play 3 short beeps
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                }, i * 250);
            }
        }

        function startContinuousBeeping() {
            // Stop any existing beep timer
            stopBeeping();
            
            // Play first beep cycle immediately
            playBeepCycle();
            
            // Set up repeating beep cycle with 1 second gap
            beepTimer = setInterval(() => {
                playBeepCycle();
            }, 1750); // 750ms for 3 beeps + 1000ms gap
        }

        function stopBeeping() {
            if (beepTimer) {
                clearInterval(beepTimer);
                beepTimer = null;
            }
        }

        function showNextExercisePreview() {
            const workout = workoutData.workouts[selectedWorkoutId];
            const nextExerciseIndex = currentExerciseIndex + 1;
            
            // Check if there's a next exercise
            if (nextExerciseIndex >= workout.exercises.length) {
                return; // No next exercise, workout is complete
            }
            
            const nextWorkoutExercise = workout.exercises[nextExerciseIndex];
            const nextExercise = resolveExercise(nextWorkoutExercise.exerciseId, nextWorkoutExercise);
            if (!nextExercise) return;
            
            // Create the preview card
            const previewContainer = document.getElementById('next-exercise-preview');
            
            // Clear existing content and add label
            previewContainer.innerHTML = '<div style="margin: 20px 0 10px 0; color: #ccc; font-size: 1.1rem;">Next Exercise:</div>';
            
            // Create exercise option div
            const div = document.createElement('div');
            div.className = 'exercise-option';
            div.style.cursor = 'pointer';
            div.onclick = () => skipToNextExercise();
            
            // Left column: exercise name and details
            let details = '';
            if (!nextExercise.duration) {
                details = `Target: ${nextExercise.targetReps} reps`;
            }
            
            // Right column: sets x weight or duration
            let rightColumn = '';
            if (nextExercise.duration) {
                rightColumn = `<div class="exercise-weight-display"><span class="sets-count">${nextExercise.sets} x</span> ${nextExercise.duration}s</div>`;
            } else if (nextExercise.currentWeight > 0) {
                rightColumn = `<div class="exercise-weight-display"><span class="sets-count">${nextExercise.sets} x</span> ${nextExercise.currentWeight} lbs</div>`;
            } else {
                rightColumn = `<div class="exercise-weight-display"><span class="sets-count">${nextExercise.sets}</span> sets</div>`;
            }
            
            div.innerHTML = `
                <div class="exercise-left">
                    <div class="exercise-name-option">${nextExercise.name}</div>
                    <div class="exercise-details">${details}</div>
                </div>
                <div class="exercise-right">
                    ${rightColumn}
                </div>
            `;
            
            previewContainer.appendChild(div);
            previewContainer.style.display = 'block';
        }

        function hideNextExercisePreview() {
            document.getElementById('next-exercise-preview').style.display = 'none';
        }

        function skipToNextExercise() {
            // Stop current timer and beeping
            stopTimer();
            
            // Move to next exercise
            const workout = workoutData.workouts[selectedWorkoutId];
            const nextExerciseIndex = currentExerciseIndex + 1;
            
            if (nextExerciseIndex < workout.exercises.length) {
                startExercise(nextExerciseIndex);
            } else {
                // No more exercises, back to exercise selection
                backToExerciseSelection();
            }
        }
        
        // Helper function to resolve exercise data by combining exercise definition with workout overrides
        function resolveExercise(exerciseId, workoutOverrides = {}) {
            const exerciseBase = workoutData.exercises[exerciseId];
            if (!exerciseBase) {
                console.error(`Exercise not found: ${exerciseId}`);
                return null;
            }
            
            return {
                ...exerciseBase,
                sets: workoutOverrides.sets !== undefined ? workoutOverrides.sets : exerciseBase.defaultSets,
                targetReps: workoutOverrides.targetReps !== undefined ? workoutOverrides.targetReps : exerciseBase.defaultTargetReps,
                restTime: workoutOverrides.restTime !== undefined ? workoutOverrides.restTime : exerciseBase.defaultRestTime,
                duration: exerciseBase.defaultDuration
            };
        }
        
        // GitHub configuration
        let githubConfig = {
            username: '',
            repo: '',
            token: ''
        };
        
        // Initialize app
        window.onload = function() {
            // Add event listener for connect button
            document.getElementById('connect-btn').addEventListener('click', setupGitHub);
            
            // Initialize edit mode (will be called again in loadWorkoutData but that's ok)
            initializeEditMode();
            
            loadGitHubConfig();
        };
        
        function initializeEditMode() {
            // Load edit mode state from localStorage
            editModeEnabled = localStorage.getItem('editMode') === 'true';
            updateEditModeButton();
            updateEditButtonVisibility();
        }
        
        function toggleEditMode() {
            editModeEnabled = !editModeEnabled;
            localStorage.setItem('editMode', editModeEnabled);
            updateEditModeButton();
            updateEditButtonVisibility();
        }
        
        function updateEditModeButton() {
            const btn = document.getElementById('edit-mode-btn');
            if (editModeEnabled) {
                btn.textContent = 'Editing';
                btn.classList.add('active');
            } else {
                btn.textContent = 'Edit';
                btn.classList.remove('active');
            }
        }
        
        function updateEditButtonVisibility() {
            const editButtons = document.querySelectorAll('.exercise-edit-btn, .workout-edit-btn');
            editButtons.forEach(btn => {
                btn.style.display = editModeEnabled ? 'block' : 'none';
            });
            
            // Show/hide settings button based on edit mode
            const settingsBtn = document.getElementById('settings-btn');
            settingsBtn.style.display = editModeEnabled ? 'inline-block' : 'none';
            
            // Refresh workout options to show/hide "Add New Day" button if on workout selection screen
            if (document.querySelector('.workout-selection').classList.contains('active')) {
                displayWorkoutOptions();
                // After refreshing, apply edit button visibility again
                setTimeout(() => {
                    const refreshedEditButtons = document.querySelectorAll('.exercise-edit-btn, .workout-edit-btn');
                    refreshedEditButtons.forEach(btn => {
                        btn.style.display = editModeEnabled ? 'block' : 'none';
                    });
                }, 0);
            }
        }
        
        // Show status messages in the setup screen
        function showStatus(elementId, message, type) {
            console.log(`showStatus: ${type} - ${message}`);
            const statusElement = document.getElementById(elementId);
            if (!statusElement) {
                console.error(`Status element not found: ${elementId}`);
                return;
            }
            
            statusElement.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        function loadGitHubConfig() {
            const saved = JSON.parse(sessionStorage.getItem('githubConfig') || '{}');
            
            if (saved.username && saved.repo && saved.token) {
                githubConfig = saved;
                loadWorkoutData();
            } else {
                showSetup();
            }
        }
        
        async function setupGitHub() {
            console.log('setupGitHub called');
            
            const connectBtn = document.getElementById('connect-btn');
            const username = document.getElementById('github-username').value.trim();
            const repo = document.getElementById('github-repo').value.trim();
            const token = document.getElementById('github-token').value.trim();
            
            console.log('Username:', username);
            console.log('Repo:', repo);
            console.log('Token provided:', token ? 'yes' : 'no');
            
            if (!username || !repo || !token) {
                console.log('Missing fields - stopping');
                showStatus('setup-status', 'Please fill in all fields', 'error');
                return;
            }
            
            console.log('All fields provided, proceeding...');
            
            // Disable button and show loading state
            connectBtn.disabled = true;
            connectBtn.textContent = 'Connecting...';
            
            githubConfig = { username, repo, token };
            sessionStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            
            console.log('githubConfig username:', githubConfig.username);
            console.log('githubConfig repo:', githubConfig.repo);
            console.log('githubConfig token length:', githubConfig.token.length);
            
            showStatus('setup-status', 'Testing connection...', 'loading');
            
            // Test connection by loading workout data
            try {
                console.log('About to call loadWorkoutData...');
                console.log('Current githubConfig username:', githubConfig.username);
                console.log('Current githubConfig repo:', githubConfig.repo);
                await loadWorkoutData(true); // Pass flag to prevent auto-navigation
                console.log('loadWorkoutData completed successfully');
                showStatus('setup-status', 'Connected successfully!', 'success');
                
                // Brief delay to show success message, then navigate
                setTimeout(() => {
                    console.log('Navigating to workout selection...');
                    showWorkoutSelection();
                }, 800);
                
            } catch (error) {
                console.error('=== CONNECTION ERROR ===');
                console.error('loadWorkoutData failed:', error);
                console.error('Error details:', error.message);
                console.error('Error stack:', error.stack);
                console.error('========================');
                
                showStatus('setup-status', `Connection failed: ${error.message}`, 'error');
                
                // Re-enable button on error
                connectBtn.disabled = false;
                connectBtn.textContent = 'Connect to GitHub';
            }
        }
        
        function loadGitHubConfig() {
            const saved = JSON.parse(sessionStorage.getItem('githubConfig') || '{}');
            
            if (saved.username && saved.repo && saved.token) {
                githubConfig = saved;
                loadWorkoutData();
            } else {
                showSetup();
            }
        }
        
        function showSetup() {
            document.querySelector('.setup-screen').classList.add('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function showWorkoutSelection() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.add('active');
            document.querySelector('.exercise-selection').classList.remove('active');
            document.querySelector('.workout-edit-screen').classList.remove('active');
            document.querySelector('.exercise-edit-screen').classList.remove('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function showExerciseSelection() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.exercise-selection').classList.add('active');
            document.querySelector('.workout-edit-screen').classList.remove('active');
            document.querySelector('.exercise-edit-screen').classList.remove('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function showWorkoutScreen() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.exercise-selection').classList.remove('active');
            document.querySelector('.workout-edit-screen').classList.remove('active');
            document.querySelector('.exercise-edit-screen').classList.remove('active');
            document.querySelector('.workout-screen').classList.add('active');
        }
        
        function backToExerciseSelection() {
            // Stop any active timers and pulsing
            stopTimer();
            stopPulsing();
            
            // Hide next exercise preview
            hideNextExercisePreview();
            
            // Clear current exercise state
            currentSession = null;
            currentExerciseIndex = 0;
            currentSet = 0;
            currentReps = 0;
            
            // Refresh exercise list to show completed status
            displayExerciseOptions();
            
            // Show exercise selection screen
            showExerciseSelection();
        }
        
        async function saveProgress() {
            const saveProgressBtn = document.getElementById('save-progress-btn');
            const isCompleteDay = saveProgressBtn.textContent.includes('Complete Day');
            
            // Create a session with all completed exercises
            const session = {
                date: new Date().toISOString(),
                workoutId: selectedWorkoutId,
                exercises: []
            };
            
            // Add all completed exercises to the session
            const workout = workoutData.workouts[selectedWorkoutId];
            completedExercises.forEach(exerciseIndex => {
                const workoutExercise = workout.exercises[exerciseIndex];
                const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
                if (!exercise) return;
                
                const exerciseRecord = {
                    name: exercise.name,
                    sets: []
                };
                
                // Add all sets for this exercise
                for (let setNum = 0; setNum < exercise.sets; setNum++) {
                    exerciseRecord.sets.push({
                        reps: exercise.targetReps,
                        weight: exercise.currentWeight || 0
                    });
                }
                
                session.exercises.push(exerciseRecord);
            });
            
            // Save the session
            completedWorkouts.sessions.push(session);
            await saveCompletedWorkouts();
            
            // Update last workout display
            displayLastWorkout();
            
            if (isCompleteDay) {
                // If completing full day, clear state and return to day selection
                completedExercises.clear();
                selectedWorkoutId = null;
                showWorkoutSelection();
                alert('🎉 Day completed and saved!');
            } else {
                // If just saving progress, stay on exercise page
                alert('💾 Progress saved!');
            }
        }
        
        function backToWorkoutSelection() {
            // Stop any active timers
            stopTimer();
            
            // Clear all workout state
            currentSession = null;
            selectedWorkoutId = null;
            completedExercises.clear();
            currentExerciseIndex = 0;
            currentSet = 0;
            currentReps = 0;
            
            // Show workout selection screen
            showWorkoutSelection();
        }
        
        // Development mode detection
        const isDevelopment = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        
        async function loadWorkoutData() {
            if (isDevelopment) {
                // Mock workout data for local development
                console.log('🚧 Development mode: Using mock data');
                workoutData = {
                    "exercises": {
                        "chest-press": {
                            "id": "chest-press",
                            "name": "Chest Press (machine)",
                            "type": "strength",
                            "muscleGroups": ["chest", "triceps", "shoulders"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 85,
                            "notes": ""
                        },
                        "seated-row": {
                            "id": "seated-row",
                            "name": "Seated Row (machine)",
                            "type": "strength",
                            "muscleGroups": ["back", "biceps"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 70,
                            "notes": ""
                        },
                        "shoulder-press": {
                            "id": "shoulder-press",
                            "name": "Shoulder Press (machine)",
                            "type": "strength",
                            "muscleGroups": ["shoulders", "triceps"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 45,
                            "notes": ""
                        },
                        "leg-press": {
                            "id": "leg-press",
                            "name": "Leg Press (machine)",
                            "type": "strength",
                            "muscleGroups": ["quads", "glutes", "hamstrings"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 180,
                            "notes": ""
                        },
                        "plank": {
                            "id": "plank",
                            "name": "Plank",
                            "type": "isometric",
                            "muscleGroups": ["core", "shoulders"],
                            "equipment": "bodyweight",
                            "defaultSets": 3,
                            "defaultTargetReps": 1,
                            "defaultDuration": 5,
                            "defaultRestTime": 5,
                            "notes": ""
                        },
                        "standing-cable-rotations": {
                            "id": "standing-cable-rotations",
                            "name": "Standing Cable Rotations",
                            "type": "strength",
                            "muscleGroups": ["core", "shoulders"],
                            "equipment": "cable",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 25,
                            "notes": "Focus on controlled rotation"
                        },
                        "leg-extensions": {
                            "id": "leg-extensions",
                            "name": "Leg Extensions (machine)",
                            "type": "strength",
                            "muscleGroups": ["quads"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 60,
                            "notes": ""
                        },
                        "leg-curls": {
                            "id": "leg-curls",
                            "name": "Leg Curls (machine)",
                            "type": "strength",
                            "muscleGroups": ["hamstrings"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 55,
                            "notes": ""
                        },
                        "lat-pulldown": {
                            "id": "lat-pulldown",
                            "name": "Lat Pulldown (machine)",
                            "type": "strength",
                            "muscleGroups": ["back", "biceps"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 75,
                            "notes": ""
                        },
                        "cable-tricep-pushdown": {
                            "id": "cable-tricep-pushdown",
                            "name": "Cable Tricep Pushdown",
                            "type": "strength",
                            "muscleGroups": ["triceps"],
                            "equipment": "cable",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 40,
                            "notes": ""
                        },
                        "seated-back-extension": {
                            "id": "seated-back-extension",
                            "name": "Seated Back Extension",
                            "type": "strength",
                            "muscleGroups": ["lower-back"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 35,
                            "notes": ""
                        },
                        "wall-sit": {
                            "id": "wall-sit",
                            "name": "Wall Sit",
                            "type": "isometric",
                            "muscleGroups": ["quads", "glutes"],
                            "equipment": "bodyweight",
                            "defaultSets": 3,
                            "defaultTargetReps": 1,
                            "defaultDuration": 5,
                            "defaultRestTime": 5,
                            "notes": ""
                        },
                        "chest-fly": {
                            "id": "chest-fly",
                            "name": "Chest Fly (machine)",
                            "type": "strength",
                            "muscleGroups": ["chest"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 50,
                            "notes": ""
                        },
                        "cable-face-pull": {
                            "id": "cable-face-pull",
                            "name": "Cable Face Pull",
                            "type": "strength",
                            "muscleGroups": ["rear-delts", "upper-back"],
                            "equipment": "cable",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 30,
                            "notes": ""
                        },
                        "lateral-raise": {
                            "id": "lateral-raise",
                            "name": "Lateral Raise (machine or light dumbbells)",
                            "type": "strength",
                            "muscleGroups": ["side-delts"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 15,
                            "notes": ""
                        },
                        "seated-leg-adduction-abduction": {
                            "id": "seated-leg-adduction-abduction",
                            "name": "Seated Leg Adduction/Abduction",
                            "type": "strength",
                            "muscleGroups": ["hip-adductors", "hip-abductors"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 45,
                            "notes": ""
                        },
                        "assisted-pull-ups": {
                            "id": "assisted-pull-ups",
                            "name": "Assisted Pull-ups (machine)",
                            "type": "strength",
                            "muscleGroups": ["back", "biceps"],
                            "equipment": "machine",
                            "defaultSets": 3,
                            "defaultTargetReps": 15,
                            "defaultRestTime": 5,
                            "currentWeight": 80,
                            "notes": ""
                        }
                    },
                    "workouts": {
                        "day1-upper": {
                            "name": "Day 1: Full Body Emphasis on Upper Body",
                            "exercises": [
                                {"exerciseId": "chest-press", "sets": 3, "targetReps": 15},
                                {"exerciseId": "seated-row", "sets": 3, "targetReps": 15},
                                {"exerciseId": "shoulder-press", "sets": 3, "targetReps": 15},
                                {"exerciseId": "leg-press", "sets": 3, "targetReps": 15},
                                {"exerciseId": "plank", "sets": 3, "targetReps": 1},
                                {"exerciseId": "standing-cable-rotations", "sets": 3, "targetReps": 15}
                            ]
                        },
                        "day2-lower": {
                            "name": "Day 2: Full Body Emphasis on Lower Body",
                            "exercises": [
                                {"exerciseId": "leg-extensions", "sets": 3, "targetReps": 15},
                                {"exerciseId": "leg-curls", "sets": 3, "targetReps": 15},
                                {"exerciseId": "lat-pulldown", "sets": 3, "targetReps": 15},
                                {"exerciseId": "cable-tricep-pushdown", "sets": 3, "targetReps": 15},
                                {"exerciseId": "seated-back-extension", "sets": 3, "targetReps": 15},
                                {"exerciseId": "wall-sit", "sets": 3, "targetReps": 1}
                            ]
                        },
                        "day3-balance": {
                            "name": "Day 3: Full Body Balance",
                            "exercises": [
                                {"exerciseId": "chest-fly", "sets": 3, "targetReps": 15},
                                {"exerciseId": "cable-face-pull", "sets": 3, "targetReps": 15},
                                {"exerciseId": "lateral-raise", "sets": 3, "targetReps": 15},
                                {"exerciseId": "seated-leg-adduction-abduction", "sets": 3, "targetReps": 15},
                                {"exerciseId": "standing-cable-rotations", "sets": 3, "targetReps": 15},
                                {"exerciseId": "assisted-pull-ups", "sets": 3, "targetReps": 15}
                            ]
                        }
                    }
                };
                
                completedWorkouts = {
                    "sessions": [
                        {
                            "date": "2025-08-01T18:30:00.000Z",
                            "workoutId": "day1-upper",
                            "exercises": [
                                {
                                    "name": "Chest Press (machine)",
                                    "sets": [
                                        {"reps": 15, "weight": 85},
                                        {"reps": 15, "weight": 85},
                                        {"reps": 15, "weight": 85}
                                    ]
                                }
                            ]
                        }
                    ]
                };
                
                // Initialize edit mode before displaying options
                initializeEditMode();
                displayWorkoutOptions();
                displayLastWorkout();
                showWorkoutSelection();
                return;
            }
            
            // Production mode: actual GitHub API calls
            console.log('🌐 Production mode: Using GitHub API');
            console.log('=== ENTERING loadWorkoutData ===');
            console.log('githubConfig available:', typeof githubConfig);
            console.log('githubConfig.username:', githubConfig.username);
            console.log('githubConfig.repo:', githubConfig.repo);
            
            try {
                // Load workouts.json
                console.log('Loading workouts.json...');
                const workoutsUrl = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts.json`;
                console.log('Fetching URL:', workoutsUrl);
                
                const workoutsResponse = await fetch(workoutsUrl, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!workoutsResponse.ok) {
                    if (workoutsResponse.status === 404) {
                        console.log('workouts.json not found, will be created from existing file...');
                        // Will use the workouts.json structure from the repo
                        await saveWorkoutDefinitions();
                    } else {
                        throw new Error(`Failed to load workouts.json: ${workoutsResponse.status}`);
                    }
                } else {
                    console.log('Successfully loaded workouts.json');
                    const workoutsData = await workoutsResponse.json();
                    workoutData = JSON.parse(atob(workoutsData.content));
                }

                // Load workouts-completed.json  
                console.log('Loading workouts-completed.json...');
                const completedUrl = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts-completed.json`;
                
                const completedResponse = await fetch(completedUrl, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!completedResponse.ok) {
                    if (completedResponse.status === 404) {
                        console.log('workouts-completed.json not found, creating empty history...');
                        completedWorkouts = { sessions: [] };
                        await saveCompletedWorkouts();
                    } else {
                        throw new Error(`Failed to load workouts-completed.json: ${completedResponse.status}`);
                    }
                } else {
                    console.log('Successfully loaded workouts-completed.json');
                    const completedData = await completedResponse.json();
                    completedWorkouts = JSON.parse(atob(completedData.content));
                }
                
                // Initialize edit mode before displaying options
                initializeEditMode();
                displayWorkoutOptions();
                displayLastWorkout();
                
                // Only auto-show workout selection if not being called from setupGitHub
                if (!arguments[0]) {
                    console.log('Auto-showing workout selection from loadWorkoutData');
                    showWorkoutSelection();
                } else {
                    console.log('Skipping auto-navigation, controlled by setupGitHub');
                }
                
            } catch (error) {
                console.error('Full error:', error);
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error(`Network error: Unable to connect to GitHub. Check your internet connection and make sure you can access github.com`);
                } else {
                    throw new Error(`Failed to load workout data: ${error.message}`);
                }
            }
        }
        
        async function saveWorkoutDefinitions() {
            if (isDevelopment) {
                // Save to localStorage in development
                localStorage.setItem('workoutData', JSON.stringify(workoutData));
                console.log('Workout definitions saved to localStorage');
                return;
            }
            
            // In production, save to GitHub (workouts.json)
            console.log('Saving workout definitions to GitHub...');
            
            try {
                const content = btoa(JSON.stringify(workoutData, null, 2));
                const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts.json`;
                
                // First, get the current file to get its SHA (required for updates)
                let sha = null;
                try {
                    const currentResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (currentResponse.ok) {
                        const currentData = await currentResponse.json();
                        sha = currentData.sha;
                    }
                } catch (e) {
                    // File doesn't exist yet, that's ok
                }
                
                // Now save the file
                const body = {
                    message: `Update workout definitions: ${new Date().toISOString()}`,
                    content: content
                };
                
                if (sha) {
                    body.sha = sha; // Required for updates
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                console.log('Workout definitions saved to GitHub successfully');
                
            } catch (error) {
                console.error('Failed to save workout definitions to GitHub:', error);
                throw new Error(`Failed to save workout definitions: ${error.message}`);
            }
        }

        async function saveWorkoutData() {
            // This function is now focused on saving completed workout sessions
            // For now, redirect to the appropriate function
            await saveCompletedWorkouts();
        }
        
        async function saveCompletedWorkouts() {
            if (isDevelopment) {
                // Save to localStorage in development
                localStorage.setItem('completedWorkouts', JSON.stringify(completedWorkouts));
                console.log('Completed workouts saved to localStorage');
                return;
            }
            
            // In production, save to GitHub (workouts-completed.json)
            console.log('Saving completed workouts to GitHub...');
            
            try {
                const content = btoa(JSON.stringify(completedWorkouts, null, 2));
                const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/workouts-completed.json`;
                
                // First, get the current file to get its SHA (required for updates)
                let sha = null;
                try {
                    const currentResponse = await fetch(url, {
                        headers: {
                            'Authorization': `token ${githubConfig.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (currentResponse.ok) {
                        const currentData = await currentResponse.json();
                        sha = currentData.sha;
                    }
                } catch (e) {
                    // File doesn't exist yet, that's ok
                }
                
                // Now save the file
                const body = {
                    message: `Update workout progress: ${new Date().toISOString()}`,
                    content: content
                };
                
                if (sha) {
                    body.sha = sha; // Required for updates
                }
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                console.log('Completed workouts saved to GitHub successfully');
                
            } catch (error) {
                console.error('Failed to save to GitHub:', error);
                throw new Error(`Failed to save progress: ${error.message}`);
            }
        }
        
        function addExportButton() {
            if (!document.getElementById('export-btn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'export-btn';
                exportBtn.className = 'btn';
                exportBtn.style.background = '#ff9800';
                exportBtn.style.marginTop = '20px';
                exportBtn.textContent = '📤 Export Data';
                exportBtn.onclick = exportData;
                
                const settingsBtn = document.querySelector('.workout-selection button[onclick="showSetup()"]');
                settingsBtn.parentNode.insertBefore(exportBtn, settingsBtn);
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(workoutData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `workout-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
        
        // Exercise editing functionality
        let currentEditingExerciseId = null;
        let isAddingNewExercise = false;
        let addExerciseReturnScreen = null;
        
        function addExercise() {
            isAddingNewExercise = true;
            currentEditingExerciseId = null;
            
            // Determine return screen based on current active screen
            if (document.querySelector('.workout-edit-screen').classList.contains('active')) {
                addExerciseReturnScreen = 'workout-edit';
            } else {
                addExerciseReturnScreen = 'setup';
            }
            
            // Clear and populate form for new exercise
            document.getElementById('edit-exercise-title').textContent = 'Add New Exercise';
            document.getElementById('edit-exercise-name').value = '';
            document.getElementById('edit-current-weight').value = 0;
            document.getElementById('edit-default-sets').value = 3;
            document.getElementById('edit-default-reps').value = 12;
            document.getElementById('edit-rest-time').value = 60;
            document.getElementById('edit-default-duration').value = 30;
            document.getElementById('edit-notes').value = '';
            
            // Show exercise type selection for new exercises
            document.getElementById('edit-exercise-type-group').style.display = 'block';
            document.getElementById('edit-exercise-type').value = 'strength';
            
            // Hide duration field initially (will show if isometric is selected)
            document.getElementById('edit-duration-group').style.display = 'none';
            
            // Show edit screen
            showExerciseEditScreen();
        }
        
        function toggleDurationField() {
            const exerciseType = document.getElementById('edit-exercise-type').value;
            const durationGroup = document.getElementById('edit-duration-group');
            
            if (exerciseType === 'isometric') {
                durationGroup.style.display = 'block';
            } else {
                durationGroup.style.display = 'none';
            }
        }
        
        function editExercise(exerciseId) {
            isAddingNewExercise = false;
            currentEditingExerciseId = exerciseId;
            const exercise = workoutData.exercises[exerciseId];
            
            if (!exercise) {
                console.error('Exercise not found:', exerciseId);
                return;
            }
            
            // Populate form fields
            document.getElementById('edit-exercise-title').textContent = `Edit: ${exercise.name}`;
            document.getElementById('edit-exercise-name').value = exercise.name;
            document.getElementById('edit-current-weight').value = exercise.currentWeight || 0;
            document.getElementById('edit-default-sets').value = exercise.defaultSets;
            document.getElementById('edit-default-reps').value = exercise.defaultTargetReps;
            document.getElementById('edit-rest-time').value = exercise.defaultRestTime;
            document.getElementById('edit-notes').value = exercise.notes || '';
            
            // Hide exercise type selection for editing existing exercises
            document.getElementById('edit-exercise-type-group').style.display = 'none';
            
            // Handle duration field for isometric exercises
            const durationGroup = document.getElementById('edit-duration-group');
            if (exercise.defaultDuration !== undefined) {
                durationGroup.style.display = 'block';
                document.getElementById('edit-default-duration').value = exercise.defaultDuration;
            } else {
                durationGroup.style.display = 'none';
            }
            
            // Show edit screen
            showExerciseEditScreen();
        }
        
        function showExerciseEditScreen() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.exercise-selection').classList.remove('active');
            document.querySelector('.workout-edit-screen').classList.remove('active');
            document.querySelector('.exercise-edit-screen').classList.add('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function cancelEditExercise() {
            const wasAdding = isAddingNewExercise;
            const returnScreen = addExerciseReturnScreen;
            
            currentEditingExerciseId = null;
            isAddingNewExercise = false;
            addExerciseReturnScreen = null;
            
            if (wasAdding) {
                // Return to the appropriate screen based on where add was initiated
                if (returnScreen === 'workout-edit') {
                    showWorkoutEditScreen();
                } else {
                    showSetup();
                }
            } else {
                // Return to exercise selection if canceling edit
                showExerciseSelection();
            }
        }
        
        async function saveExerciseEdit() {
            if (!isAddingNewExercise && !currentEditingExerciseId) {
                console.error('No exercise being edited');
                return;
            }
            
            let exercise;
            let exerciseId;
            
            if (isAddingNewExercise) {
                // Generate a unique ID for new exercise
                exerciseId = document.getElementById('edit-exercise-name').value.toLowerCase()
                    .replace(/\s+/g, '-')
                    .replace(/[^a-z0-9-]/g, '');
                
                // Ensure ID is unique
                let baseId = exerciseId;
                let counter = 1;
                while (workoutData.exercises[exerciseId]) {
                    exerciseId = `${baseId}-${counter}`;
                    counter++;
                }
                
                exercise = {};
            } else {
                exercise = workoutData.exercises[currentEditingExerciseId];
                exerciseId = currentEditingExerciseId;
                if (!exercise) {
                    console.error('Exercise not found:', currentEditingExerciseId);
                    return;
                }
            }
            
            // Get form values
            const name = document.getElementById('edit-exercise-name').value.trim();
            const currentWeight = parseInt(document.getElementById('edit-current-weight').value) || 0;
            const defaultSets = parseInt(document.getElementById('edit-default-sets').value) || 3;
            const defaultTargetReps = parseInt(document.getElementById('edit-default-reps').value) || 12;
            const defaultRestTime = parseInt(document.getElementById('edit-rest-time').value) || 60;
            const notes = document.getElementById('edit-notes').value.trim();
            
            // Validation
            if (!name) {
                alert('Exercise name is required');
                return;
            }
            
            if (defaultSets < 1 || defaultSets > 10) {
                alert('Sets must be between 1 and 10');
                return;
            }
            
            if (defaultTargetReps < 1 || defaultTargetReps > 50) {
                alert('Target reps must be between 1 and 50');
                return;
            }
            
            if (defaultRestTime < 30 || defaultRestTime > 300) {
                alert('Rest time must be between 30 and 300 seconds');
                return;
            }
            
            // Update exercise data
            exercise.id = exerciseId;
            exercise.name = name;
            exercise.currentWeight = currentWeight;
            exercise.defaultSets = defaultSets;
            exercise.defaultTargetReps = defaultTargetReps;
            exercise.defaultRestTime = defaultRestTime;
            exercise.notes = notes;
            
            // Set exercise type and additional properties for new exercises
            if (isAddingNewExercise) {
                const exerciseType = document.getElementById('edit-exercise-type').value;
                exercise.type = exerciseType;
                exercise.muscleGroups = ["general"]; // Default muscle group
                exercise.equipment = "machine"; // Default equipment
                
                if (exerciseType === 'isometric') {
                    const defaultDuration = parseInt(document.getElementById('edit-default-duration').value) || 30;
                    if (defaultDuration < 5 || defaultDuration > 300) {
                        alert('Duration must be between 5 and 300 seconds');
                        return;
                    }
                    exercise.defaultDuration = defaultDuration;
                }
            } else {
                // Handle duration for existing isometric exercises
                if (exercise.defaultDuration !== undefined) {
                    const defaultDuration = parseInt(document.getElementById('edit-default-duration').value) || 30;
                    if (defaultDuration < 5 || defaultDuration > 300) {
                        alert('Duration must be between 5 and 300 seconds');
                        return;
                    }
                    exercise.defaultDuration = defaultDuration;
                }
            }
            
            try {
                // Add new exercise to the exercises collection
                if (isAddingNewExercise) {
                    workoutData.exercises[exerciseId] = exercise;
                }
                
                // Save to storage
                await saveWorkoutDefinitions();
                
                // Show success message
                const successMessage = isAddingNewExercise ? 
                    'Exercise created successfully!' : 
                    'Exercise updated successfully!';
                alert(successMessage);
                
                // Reset state
                const wasAdding = isAddingNewExercise;
                const returnScreen = addExerciseReturnScreen;
                currentEditingExerciseId = null;
                isAddingNewExercise = false;
                addExerciseReturnScreen = null;
                
                // Navigate back to appropriate screen
                if (wasAdding) {
                    if (returnScreen === 'workout-edit') {
                        // Refresh available exercises list and return to workout edit
                        displayAvailableExercises();
                        showWorkoutEditScreen();
                    } else {
                        showSetup();
                    }
                } else {
                    // Refresh exercise list to show updated data
                    displayExerciseOptions();
                    showExerciseSelection();
                }
                
            } catch (error) {
                console.error('Failed to save exercise:', error);
                alert('Failed to save exercise: ' + error.message);
            }
        }
        
        // Workout editing functionality
        let currentEditingWorkoutId = null;
        let isAddingNewDay = false;
        
        function editWorkout(workoutId) {
            isAddingNewDay = false;
            currentEditingWorkoutId = workoutId;
            const workout = workoutData.workouts[workoutId];
            
            if (!workout) {
                console.error('Workout not found:', workoutId);
                return;
            }
            
            // Set title and populate workout name field
            document.getElementById('workout-edit-title').textContent = `Edit: ${workout.name}`;
            document.getElementById('edit-workout-name').value = workout.name;
            
            // Populate current exercises
            displayCurrentWorkoutExercises();
            
            // Populate available exercises
            displayAvailableExercises();
            
            // Show workout edit screen
            showWorkoutEditScreen();
        }
        
        function showWorkoutEditScreen() {
            document.querySelector('.setup-screen').classList.remove('active');
            document.querySelector('.workout-selection').classList.remove('active');
            document.querySelector('.exercise-selection').classList.remove('active');
            document.querySelector('.workout-edit-screen').classList.add('active');
            document.querySelector('.exercise-edit-screen').classList.remove('active');
            document.querySelector('.workout-screen').classList.remove('active');
        }
        
        function cancelEditWorkout() {
            // If we were adding a new day, remove it from the data
            if (isAddingNewDay && currentEditingWorkoutId) {
                delete workoutData.workouts[currentEditingWorkoutId];
            }
            
            currentEditingWorkoutId = null;
            isAddingNewDay = false;
            showWorkoutSelection();
        }
        
        function displayCurrentWorkoutExercises() {
            const workout = workoutData.workouts[currentEditingWorkoutId];
            const container = document.getElementById('current-exercises');
            container.innerHTML = '';
            
            workout.exercises.forEach((workoutExercise, index) => {
                const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
                if (!exercise) return;
                
                const div = document.createElement('div');
                div.className = 'workout-exercise-item';
                div.draggable = true;
                div.dataset.exerciseIndex = index;
                
                // Add drag event listeners
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragend', handleDragEnd);
                
                div.innerHTML = `
                    <span class="drag-handle">⋮⋮</span>
                    <div class="exercise-info">
                        <div class="exercise-name">${exercise.name}</div>
                        <div class="exercise-sets">${exercise.sets} sets × ${exercise.targetReps}${exercise.duration ? 's hold' : ' reps'}</div>
                    </div>
                    <button class="remove-btn" onclick="removeExerciseFromWorkout(${index})">✕</button>
                `;
                
                container.appendChild(div);
            });
            
            // Add drop event listeners to container
            container.addEventListener('dragover', handleDragOver);
            container.addEventListener('drop', handleDrop);
        }
        
        function displayAvailableExercises() {
            const workout = workoutData.workouts[currentEditingWorkoutId];
            const container = document.getElementById('available-exercises');
            container.innerHTML = '';
            
            // Get list of exercise IDs already in the workout
            const usedExerciseIds = workout.exercises.map(we => we.exerciseId);
            
            Object.keys(workoutData.exercises).forEach(exerciseId => {
                // Skip exercises already in the workout
                if (usedExerciseIds.includes(exerciseId)) return;
                
                const exercise = workoutData.exercises[exerciseId];
                const div = document.createElement('div');
                div.className = 'available-exercise-item';
                div.onclick = () => addExerciseToWorkout(exerciseId);
                
                div.innerHTML = `
                    <div class="exercise-name">${exercise.name}</div>
                    <div class="exercise-details">${exercise.defaultSets} sets × ${exercise.defaultTargetReps}${exercise.defaultDuration ? 's hold' : ' reps'}</div>
                `;
                
                container.appendChild(div);
            });
            
            // Add "Add New Exercise" button at the end (only in edit mode)
            if (editModeEnabled) {
                const addBtn = document.createElement('div');
                addBtn.className = 'available-exercise-item';
                addBtn.style.background = '#2196F3';
                addBtn.style.textAlign = 'center';
                addBtn.style.fontWeight = 'bold';
                addBtn.onclick = () => addExercise();
                
                addBtn.innerHTML = `
                    <div class="exercise-name">➕ Add New Exercise</div>
                    <div class="exercise-details">Create a custom exercise</div>
                `;
                
                container.appendChild(addBtn);
            }
        }
        
        function addExerciseToWorkout(exerciseId) {
            const workout = workoutData.workouts[currentEditingWorkoutId];
            const exercise = workoutData.exercises[exerciseId];
            
            // Add exercise to workout with default values
            const workoutExercise = {
                exerciseId: exerciseId,
                sets: exercise.defaultSets,
                targetReps: exercise.defaultTargetReps
            };
            
            workout.exercises.push(workoutExercise);
            
            // Refresh displays
            displayCurrentWorkoutExercises();
            displayAvailableExercises();
        }
        
        function removeExerciseFromWorkout(index) {
            const workout = workoutData.workouts[currentEditingWorkoutId];
            workout.exercises.splice(index, 1);
            
            // Refresh displays
            displayCurrentWorkoutExercises();
            displayAvailableExercises();
        }
        
        async function saveWorkoutEdit() {
            try {
                // Update workout name
                const workout = workoutData.workouts[currentEditingWorkoutId];
                const newName = document.getElementById('edit-workout-name').value.trim();
                
                if (!newName) {
                    alert('Workout name is required');
                    return;
                }
                
                workout.name = newName;
                
                // Save to storage
                await saveWorkoutDefinitions();
                
                const successMessage = isAddingNewDay ? 
                    'New workout day created successfully!' : 
                    'Workout updated successfully!';
                alert(successMessage);
                
                currentEditingWorkoutId = null;
                isAddingNewDay = false;
                
                // Refresh workout list and return to selection
                displayWorkoutOptions();
                showWorkoutSelection();
                
            } catch (error) {
                console.error('Failed to save workout:', error);
                alert('Failed to save workout: ' + error.message);
            }
        }
        
        // Drag and drop functionality
        let draggedElement = null;
        
        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            draggedElement = null;
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            this.classList.add('drag-over');
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            this.classList.remove('drag-over');
            
            if (draggedElement !== e.target && draggedElement !== null) {
                const draggedIndex = parseInt(draggedElement.dataset.exerciseIndex);
                const targetElement = e.target.closest('.workout-exercise-item');
                
                if (targetElement) {
                    const targetIndex = parseInt(targetElement.dataset.exerciseIndex);
                    
                    // Reorder exercises in the workout data
                    const workout = workoutData.workouts[currentEditingWorkoutId];
                    const draggedExercise = workout.exercises[draggedIndex];
                    
                    // Remove from old position
                    workout.exercises.splice(draggedIndex, 1);
                    
                    // Insert at new position
                    const newIndex = draggedIndex < targetIndex ? targetIndex - 1 : targetIndex;
                    workout.exercises.splice(newIndex, 0, draggedExercise);
                    
                    // Refresh display
                    displayCurrentWorkoutExercises();
                }
            }
            
            return false;
        }
        
        function addNewDay() {
            isAddingNewDay = true;
            
            // Generate a unique ID for new workout
            let workoutId = 'day-custom';
            let counter = 1;
            while (workoutData.workouts[workoutId]) {
                workoutId = `day-custom-${counter}`;
                counter++;
            }
            
            currentEditingWorkoutId = workoutId;
            
            // Create a new empty workout
            workoutData.workouts[workoutId] = {
                name: 'New Workout Day',
                exercises: []
            };
            
            // Set title and populate workout name field
            document.getElementById('workout-edit-title').textContent = 'Add New Day';
            document.getElementById('edit-workout-name').value = 'New Workout Day';
            
            // Populate current exercises (empty)
            displayCurrentWorkoutExercises();
            
            // Populate all available exercises
            displayAvailableExercises();
            
            // Show workout edit screen
            showWorkoutEditScreen();
        }
        
        function displayWorkoutOptions() {
            const container = document.getElementById('workout-options');
            container.innerHTML = '';
            
            Object.keys(workoutData.workouts).forEach(workoutId => {
                const workout = workoutData.workouts[workoutId];
                const div = document.createElement('div');
                div.className = 'workout-option';
                div.onclick = () => startWorkout(workoutId);
                
                div.innerHTML = `
                    <button class="workout-edit-btn" onclick="editWorkout('${workoutId}'); event.stopPropagation();" title="Edit Workout" style="display: ${editModeEnabled ? 'block' : 'none'};">⚙️</button>
                    <div class="workout-title">${workout.name}</div>
                    <div class="exercise-count">${workout.exercises.length} exercises</div>
                `;
                
                container.appendChild(div);
            });
            
            // Add "Add New Day" button at the end (only in edit mode)
            if (editModeEnabled) {
                const addDayBtn = document.createElement('div');
                addDayBtn.className = 'workout-option';
                addDayBtn.style.background = '#2196F3';
                addDayBtn.style.textAlign = 'center';
                addDayBtn.style.fontWeight = 'bold';
                addDayBtn.onclick = () => addNewDay();
                
                addDayBtn.innerHTML = `
                    <div class="workout-title">➕ Add New Day</div>
                    <div class="exercise-count">Create a custom workout day</div>
                `;
                
                container.appendChild(addDayBtn);
            }
        }
        
        function displayLastWorkout() {
            const lastWorkoutText = document.getElementById('last-workout-text');
            
            if (!completedWorkouts || completedWorkouts.sessions.length === 0) {
                lastWorkoutText.textContent = 'None recorded';
                return;
            }
            
            const lastSession = completedWorkouts.sessions[completedWorkouts.sessions.length - 1];
            const date = new Date(lastSession.date);
            const workoutName = workoutData.workouts[lastSession.workoutId]?.name || 'Unknown workout';
            
            lastWorkoutText.textContent = `${workoutName} on ${date.toLocaleDateString()} at ${date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
        }
        
        function startWorkout(workoutId) {
            selectedWorkoutId = workoutId;
            completedExercises.clear(); // Clear completed exercises for new workout
            const workout = workoutData.workouts[workoutId];
            
            // Update exercise selection title
            document.getElementById('exercise-selection-title').textContent = workout.name;
            
            // Display exercises for selection
            displayExerciseOptions();
            
            showExerciseSelection();
        }
        
        function displayExerciseOptions() {
            const workout = workoutData.workouts[selectedWorkoutId];
            const container = document.getElementById('exercise-options');
            container.innerHTML = '';
            
            workout.exercises.forEach((workoutExercise, index) => {
                const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
                if (!exercise) return;
                
                const div = document.createElement('div');
                div.className = completedExercises.has(index) ? 'exercise-option completed' : 'exercise-option';
                div.onclick = () => startExercise(index);
                
                // Left column: exercise name and details
                let details = '';
                if (!exercise.duration) {
                    details = `Target: ${exercise.targetReps} reps`;
                }
                
                // Right column: sets x weight or duration
                let rightColumn = '';
                if (exercise.duration) {
                    rightColumn = `<div class="exercise-weight-display"><span class="sets-count">${exercise.sets} x</span> ${exercise.duration}s</div>`;
                } else if (exercise.currentWeight > 0) {
                    rightColumn = `<div class="exercise-weight-display"><span class="sets-count">${exercise.sets} x</span> ${exercise.currentWeight} lbs</div>`;
                } else {
                    rightColumn = `<div class="exercise-weight-display"><span class="sets-count">${exercise.sets}</span> sets</div>`;
                }
                
                div.innerHTML = `
                    <button class="exercise-edit-btn" onclick="editExercise('${workoutExercise.exerciseId}'); event.stopPropagation();" title="Edit Exercise" style="display: ${editModeEnabled ? 'block' : 'none'};">⚙️</button>
                    <div class="exercise-left">
                        <div class="exercise-name-option">${exercise.name}</div>
                        <div class="exercise-details">${details}</div>
                    </div>
                    <div class="exercise-right">
                        ${rightColumn}
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            // Update button text based on completion status
            const saveProgressBtn = document.getElementById('save-progress-btn');
            if (completedExercises.size === workout.exercises.length) {
                saveProgressBtn.textContent = '🎉 Complete Day';
                saveProgressBtn.style.background = '#4CAF50';
            } else {
                saveProgressBtn.textContent = 'Save Progress';
                saveProgressBtn.style.background = '#2196F3';
            }
            
            // Update edit button visibility
            updateEditButtonVisibility();
        }
        
        function startExercise(exerciseIndex) {
            currentSession = {
                date: new Date().toISOString(),
                workoutId: selectedWorkoutId,
                exercises: []
            };
            
            currentExerciseIndex = exerciseIndex;
            currentSet = 0;
            currentReps = 0;
            
            // Hide next exercise preview when starting new exercise
            hideNextExercisePreview();
            
            showWorkoutScreen();
            displayCurrentExercise();
        }
        
        function displayCurrentExercise() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const workoutExercise = workout.exercises[currentExerciseIndex];
            const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
            if (!exercise) return;
            
            document.getElementById('current-exercise-name').textContent = exercise.name;
            
            // Display sets count with weight or duration prominently
            const weightElement = document.getElementById('current-exercise-weight');
            if (exercise.duration) {
                // For time-based exercises, show sets x duration
                weightElement.innerHTML = `<span class="sets-count">${exercise.sets} x</span> ${exercise.duration}s hold`;
                weightElement.style.display = 'block';
            } else if (exercise.currentWeight > 0) {
                // For weight-based exercises, show sets x weight
                weightElement.innerHTML = `<span class="sets-count">${exercise.sets} x</span> ${exercise.currentWeight} lbs`;
                weightElement.style.display = 'block';
            } else {
                // For bodyweight exercises, just show sets
                weightElement.innerHTML = `<span class="sets-count">${exercise.sets}</span> sets`;
                weightElement.style.display = 'block';
            }
            
            let info = `Set ${currentSet + 1}`;
            if (!exercise.duration) {
                info += ` • Target: ${exercise.targetReps} reps`;
            }
            
            document.getElementById('current-exercise-info').textContent = info;
            document.getElementById('set-info').textContent = ``;
            
            // Update button text based on exercise type
            const completeSetBtn = document.getElementById('complete-set-btn');
            if (exercise.duration) {
                completeSetBtn.textContent = `Start Set ${currentSet + 1}`;
                completeSetBtn.onclick = () => startTimedSet();
            } else {
                completeSetBtn.textContent = `Mark Set ${currentSet + 1} Done`;
                completeSetBtn.onclick = () => completeSet();
            }
            
            // Hide all control buttons initially
            document.getElementById('next-set-btn').style.display = 'none';
            document.getElementById('next-exercise-btn').style.display = 'none';
            document.getElementById('finish-btn').style.display = 'none';
            
            // Show complete set button
            document.getElementById('complete-set-btn').style.display = 'block';
            
            stopTimer();
        }
        
        function startTimedSet() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const workoutExercise = workout.exercises[currentExerciseIndex];
            const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
            if (!exercise) return;
            
            // Hide the start button
            document.getElementById('complete-set-btn').style.display = 'none';
            
            // Start the exercise timer (countdown)
            startExerciseTimer(exercise.duration);
        }
        
        function completeSet() {
            // Stop any pulsing animation
            stopPulsing();
            
            const workout = workoutData.workouts[currentSession.workoutId];
            const workoutExercise = workout.exercises[currentExerciseIndex];
            const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
            if (!exercise) return;
            
            // Record the completed set
            recordSet();
            
            // Hide the complete set button
            document.getElementById('complete-set-btn').style.display = 'none';
            
            // Show appropriate next action button immediately (but disabled)
            if (currentSet < exercise.sets - 1) {
                const nextSetBtn = document.getElementById('next-set-btn');
                nextSetBtn.style.display = 'block';
                nextSetBtn.disabled = true;
                
                // Enable button after 2 seconds
                setTimeout(() => {
                    nextSetBtn.disabled = false;
                }, 2000);
            } else {
                // Exercise is complete - mark it as completed
                completedExercises.add(currentExerciseIndex);
                document.getElementById('next-exercise-btn').style.display = 'block';
                
                // Show next exercise preview during final rest
                showNextExercisePreview();
            }
            
            // Start rest timer
            startRestTimer(exercise.restTime);
        }
        
        
        function nextSet() {
            // Stop any pulsing animation
            stopPulsing();
            
            currentSet++;
            currentReps = 0;
            displayCurrentExercise();
        }
        
        function nextExercise() {
            currentExerciseIndex++;
            currentSet = 0;
            currentReps = 0;
            displayCurrentExercise();
        }
        
        function recordSet() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const workoutExercise = workout.exercises[currentExerciseIndex];
            const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
            if (!exercise) return;
            
            // Find or create exercise record in current session
            let exerciseRecord = currentSession.exercises.find(e => e.name === exercise.name);
            if (!exerciseRecord) {
                exerciseRecord = {
                    name: exercise.name,
                    sets: []
                };
                currentSession.exercises.push(exerciseRecord);
            }
            
            // Add the completed set with target reps
            exerciseRecord.sets.push({
                reps: exercise.targetReps,
                weight: exercise.currentWeight || 0
            });
        }
        
        async function finishWorkout() {
            // Save session to completed workouts
            completedWorkouts.sessions.push(currentSession);
            
            // Save completed workouts history
            await saveCompletedWorkouts();
            
            // Return to workout selection
            showWorkoutSelection();
            displayLastWorkout();
            
            alert('Workout completed and saved!');
        }
        
        function startRestTimer(seconds) {
            startTimer(seconds, false, 'Rest Timer');
        }
        
        function startExerciseTimer(seconds) {
            startTimer(seconds, true, 'Exercise Timer');
        }
        
        function startTimer(seconds, isExercise, label) {
            stopTimer();
            
            timerSeconds = seconds;
            isExerciseTimer = isExercise;
            
            const timerSection = document.getElementById('timer-section');
            const timerDisplay = document.getElementById('timer-display');
            const timerLabel = document.getElementById('timer-label');
            
            timerLabel.textContent = label;
            timerSection.style.display = 'block';
            
            if (isExercise) {
                timerSection.className = 'timer exercise-timer';
                
                // Show next set button immediately for exercise timers
                const workout = workoutData.workouts[currentSession.workoutId];
                const workoutExercise = workout.exercises[currentExerciseIndex];
                const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
                if (exercise && currentSet < exercise.sets - 1) {
                    document.getElementById('next-set-btn').style.display = 'block';
                } else if (exercise) {
                    // Exercise is complete after this set - mark it as completed
                    completedExercises.add(currentExerciseIndex);
                    document.getElementById('next-exercise-btn').style.display = 'block';
                }
            } else {
                timerSection.className = 'timer rest-timer';
            }
            
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timerSeconds--;
                updateTimerDisplay();
                
                if (timerSeconds <= 0) {
                    // Timer expired - trigger effects
                    const timerDisplay = document.getElementById('timer-display');
                    timerDisplay.classList.add('timer-expired');
                    console.log('Added timer-expired class:', timerDisplay.className);
                    startContinuousBeeping();
                    
                    // Stop the interval but keep timer visible with pulsing
                    if (timer) {
                        clearInterval(timer);
                        timer = null;
                    }
                    
                    // Update display to show 00:00
                    timerDisplay.textContent = '00:00';
                    
                    if (isExercise) {
                        // Exercise timer finished, show complete set button
                        onExerciseTimerComplete();
                    }
                }
            }, 1000);
        }
        
        function onExerciseTimerComplete() {
            const workout = workoutData.workouts[currentSession.workoutId];
            const workoutExercise = workout.exercises[currentExerciseIndex];
            const exercise = resolveExercise(workoutExercise.exerciseId, workoutExercise);
            if (!exercise) return;
            
            // Hide the next set button when timer expires
            document.getElementById('next-set-btn').style.display = 'none';
            document.getElementById('next-exercise-btn').style.display = 'none';
            
            // Show the complete set button
            const completeSetBtn = document.getElementById('complete-set-btn');
            completeSetBtn.textContent = `Mark Set ${currentSet + 1} Done`;
            completeSetBtn.onclick = () => completeSet();
            document.getElementById('complete-set-btn').style.display = 'block';
            
            // Update status text - no message needed for isometric exercises
            document.getElementById('set-info').textContent = ``;
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timerSeconds / 60);
            const seconds = timerSeconds % 60;
            const display = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timer-display').textContent = display;
        }
        
        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
            
            // Stop continuous beeping
            stopBeeping();
            
            document.getElementById('timer-section').style.display = 'none';
            
            // Remove pulsing animation
            document.getElementById('timer-display').classList.remove('timer-expired');
        }
        
        function stopPulsing() {
            document.getElementById('timer-display').classList.remove('timer-expired');
        }
        
        function showOfflineOption() {
            document.getElementById('offline-option').style.display = 'block';
        }
        
        function useOfflineMode() {
            // Initialize with default workout data using new normalized structure
            workoutData = {
                "exercises": {
                    "chest-press": {
                        "id": "chest-press",
                        "name": "Chest Press (machine)",
                        "type": "strength",
                        "muscleGroups": ["chest", "triceps", "shoulders"],
                        "equipment": "machine",
                        "defaultSets": 3,
                        "defaultTargetReps": 15,
                        "defaultRestTime": 60,
                        "currentWeight": 0,
                        "notes": ""
                    },
                    "seated-row": {
                        "id": "seated-row",
                        "name": "Seated Row (machine)",
                        "type": "strength",
                        "muscleGroups": ["back", "biceps"],
                        "equipment": "machine",
                        "defaultSets": 3,
                        "defaultTargetReps": 15,
                        "defaultRestTime": 60,
                        "currentWeight": 0,
                        "notes": ""
                    },
                    "plank": {
                        "id": "plank",
                        "name": "Plank",
                        "type": "isometric",
                        "muscleGroups": ["core", "shoulders"],
                        "equipment": "bodyweight",
                        "defaultSets": 3,
                        "defaultTargetReps": 1,
                        "defaultDuration": 30,
                        "defaultRestTime": 60,
                        "notes": ""
                    }
                },
                "workouts": {
                    "day1-upper": {
                        "name": "Day 1: Full Body Emphasis on Upper Body",
                        "exercises": [
                            {"exerciseId": "chest-press", "sets": 3, "targetReps": 15},
                            {"exerciseId": "seated-row", "sets": 3, "targetReps": 15},
                            {"exerciseId": "plank", "sets": 3, "targetReps": 1}
                        ]
                    }
                }
            };
            
            // Initialize empty completed workouts
            completedWorkouts = { sessions: [] };
            
            // Mark as offline mode
            sessionStorage.setItem('offlineMode', 'true');
            
            // Initialize edit mode before displaying options
            initializeEditMode();
            displayWorkoutOptions();
            displayLastWorkout();
            showWorkoutSelection();
            
            // Add export button to workout selection
            addExportButton();
        }
        
        function addExportButton() {
            if (!document.getElementById('export-btn')) {
                const exportBtn = document.createElement('button');
                exportBtn.id = 'export-btn';
                exportBtn.className = 'btn';
                exportBtn.style.background = '#ff9800';
                exportBtn.style.marginTop = '20px';
                exportBtn.textContent = '📤 Export Data';
                exportBtn.onclick = exportData;
                
                document.querySelector('.workout-selection').appendChild(exportBtn);
            }
        }
        
        function exportData() {
            const dataStr = JSON.stringify(workoutData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `workout-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
